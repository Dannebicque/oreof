{# templates/components/NotificationCenter.html.twig #}
<div class="space-y-6" data-action="live#action:notif:saved->live#update">
    {# 1) Global #}
    {% set global = app.user.notificationPreference %}
    <div class="p-4 rounded-xl border bg-white">
        <div class="flex items-center justify-between">
            <div>
                <div class="font-semibold">Notifications globales (par défaut)</div>
                <div class="text-xs text-gray-500">S’applique à tout, sauf si vous personnalisez plus bas.</div>
            </div>
            <div class="flex items-center gap-3">
                <label class="flex items-center gap-1 text-sm">
                    <input type="checkbox"
                           data-model="emailGlobal" {{ global is not null and global.emailEnabled ? 'checked' }} />
                    Email
                </label>
                <label class="flex items-center gap-1 text-sm">
                    <input type="checkbox"
                           data-model="inappGlobal" {{ global is not null and global.inAppEnabled ? 'checked' }} />
                    In-app
                </label>
                <button class="px-3 py-1.5 text-sm rounded bg-blue-600 text-white"
                        data-action="live#action"
                        data-live-action-param="saveGlobal"
                        data-live-args='{
            "email": document.querySelector("[data-model=emailGlobal]").checked,
            "inapp": document.querySelector("[data-model=inappGlobal]").checked
          }'>Enregistrer
                </button>
            </div>
        </div>
    </div>

    {# 2) Par workflow / place / transition #}
    {% for wf in this.getWorkflows() %}
        <div class="p-4 rounded-xl border bg-white space-y-4">
            <div class="font-semibold">Workflow : {{ wf.name }}</div>

            {# Niveau workflow #}
            {% set res = this.resolve(wf.name) %}
            <div class="flex items-center justify-between border rounded p-3">
                <div>
                    <div class="font-medium">Par défaut pour {{ wf.name }}</div>
                    <div class="text-xs text-gray-500">
                        {% if res.source == 'workflow' %}
                            <span class="px-2 py-0.5 rounded bg-indigo-100 text-indigo-700">Personnalisé</span>
                        {% else %}
                            <span class="px-2 py-0.5 rounded bg-gray-100 text-gray-700">Hérité : {{ res.source }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    {% set ch = res.channels %}
                    {% include 'components/_notif_toggles.html.twig' with {
                        scope: {workflow:wf.name, place: null, transition: null},
                        channels: ch, inherited: res.source != 'workflow'
                    } %}
                </div>
            </div>

            {# Étapes #}
            {% for p in wf.places %}
                {% set rp = this.resolve(wf.name, p.name) %}
                <div class="border rounded p-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-medium">Étape : {{ p.label|trans }}</div>
                            <div class="text-xs text-gray-500">
                                {% if rp.source == 'step' %}
                                    <span class="px-2 py-0.5 rounded bg-indigo-100 text-indigo-700">Personnalisé</span>
                                {% else %}
                                    <span class="px-2 py-0.5 rounded bg-gray-100 text-gray-700">Hérité : {{ rp.source }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            {% include 'components/_notif_toggles.html.twig' with {
                                scope: {workflow:wf.name, place: p.name, transition: null},
                                channels: rp.channels, inherited: rp.source != 'step'
                            } %}
                        </div>
                    </div>

                    {# Transitions partant de l’étape #}
                    {% for t in (wf.transitionsByPlace[p.name] ?? []) %}
                        {% set rt = this.resolve(wf.name, p.name, t.name) %}
                        <div class="mt-3 ml-6 flex items-center justify-between border rounded p-3">
                            <div>
                                <div class="text-sm font-medium">Transition : {{ t.label|trans }}</div>
                                <div class="text-xs text-gray-500">
                                    {% if rt.source == 'transition' %}
                                        <span class="px-2 py-0.5 rounded bg-indigo-100 text-indigo-700">Personnalisé</span>
                                    {% else %}
                                        <span class="px-2 py-0.5 rounded bg-gray-100 text-gray-700">Hérité : {{ rt.source }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                {% include 'components/_notif_toggles.html.twig' with {
                                    scope: {workflow:wf.name, place: p.name, transition: t.name},
                                    channels: rt.channels, inherited: rt.source != 'transition'
                                } %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    {% endfor %}
</div>
