{# templates/components/NotificationCenter.html.twig #}
<div class="mb-4 bg-opacity-25" data-action="live#action:notif:saved->live#update">
    {# 1) Global #}
    {% set global = app.user.notificationPreference %}
    <div class="p-4 rounded border bg-white">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <div class="fw-semibold">Notifications globales (par défaut)</div>
                <div class="text-muted small">S’applique à tout, sauf si vous personnalisez plus bas.</div>
            </div>
            <div class="d-flex align-items-center gap-3">
                <label class="d-flex align-items-center gap-1 small mb-0">
                    <input type="checkbox"
                           data-model="emailGlobal" {{ global is not null and global.emailEnabled ? 'checked' }} />
                    Email
                </label>
                <label class="d-flex align-items-center gap-1 small mb-0">
                    <input type="checkbox"
                           data-model="inappGlobal" {{ global is not null and global.inAppEnabled ? 'checked' }} />
                    In-app
                </label>
                <button class="px-3 py-1 btn btn-primary btn-sm"
                        data-action="live#action"
                        data-live-action-param="saveGlobal"
                        data-live-args='{
            "email": document.querySelector("[data-model=emailGlobal]").checked,
            "inapp": document.querySelector("[data-model=inappGlobal]").checked
          }'>Enregistrer
                </button>
            </div>
        </div>
    </div>

    {# 2) Par workflow / place / transition #}
    {% for wf in this.getWorkflows() %}
        <div class="p-4 rounded border mt-3 bg-white mb-4">
            <div class="fw-semibold">Workflow : {{ wf.name }}</div>

            {# Niveau workflow #}
            {% set res = this.resolve(wf.name) %}
            <div class="d-flex align-items-center justify-content-between border rounded p-3 mb-3">
                <div>
                    <div class="fw-medium">Par défaut pour {{ wf.name }}</div>
                    <div class="text-muted small">
                        {% if res.source == 'workflow' %}
                            <span class="px-2 py-1 rounded bg-primary bg-opacity-10 text-primary">Personnalisé</span>
                        {% endif %}
                        <span class="px-2 py-1 rounded bg-light text-secondary">Hérité : {{ res.source }}</span>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    {% set ch = res.channels %}
                    {% include 'components/_notif_toggles.html.twig' with {
                        scope: {workflow:wf.name, place: null, transition: null},
                        channels: ch, inherited: res.source != 'workflow'
                    } %}
                </div>
            </div>

            {# Étapes #}
            {% for p in wf.places %}
                {% set rp = this.resolve(wf.name, p.name) %}
                <div class="border rounded p-3 mb-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="fw-medium">Étape : {{ p.label|trans }}</div>
                            <div class="text-muted small">
                                {% if rp.source == 'step' %}
                                    <span class="px-2 py-1 rounded bg-primary bg-opacity-10 text-primary">Personnalisé</span>
                                {% endif %}
                                <span class="px-2 py-1 rounded bg-light text-secondary">Hérité : {{ rp.source }}</span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            {% include 'components/_notif_toggles.html.twig' with {
                                scope: {workflow:wf.name, place: p.name, transition: null},
                                channels: rp.channels, inherited: rp.source != 'step'
                            } %}
                        </div>
                    </div>

                    {# Transitions partant de l’étape #}
                    {% for t in (wf.transitionsByPlace[p.name] ?? []) %}
                        {% set rt = this.resolve(wf.name, p.name, t.name) %}
                        <div class="mt-3 ms-4 d-flex align-items-center justify-content-between border rounded p-3">
                            <div>
                                <div class="small fw-medium">Transition : {{ t.label|trans }}</div>
                                <div class="text-muted small">
                                    {% if rt.source == 'transition' %}
                                        <span class="px-2 py-1 rounded bg-primary bg-opacity-10 text-primary">Personnalisé</span>
                                    {% endif %}
                                    <span class="px-2 py-1 rounded bg-light text-secondary">Hérité : {{ rt.source }}</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                {% include 'components/_notif_toggles.html.twig' with {
                                    scope: {workflow:wf.name, place: p.name, transition: t.name},
                                    channels: rt.channels, inherited: rt.source != 'transition'
                                } %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    {% endfor %}
</div>
