<div {{ attributes }} class="bg-white rounded-sm p-2 mb-4 border border-2 border-blue-500 shadow-sm scroll-mt-32">
    {% if parcours.isParcoursDefaut == true %}
        {% set prefix = 'formation' %}
    {% else %}
        {% set prefix = 'parcours' %}
    {% endif %}

    <div class="container-fluid px-lg-4 pt-3">
        <div class="mb-3 p-3 bg-light rounded border">
            <div class="row g-3 small">
                <div class="col-12 col-sm-6 col-lg-2">
                    <dt class="fw-medium text-muted mb-1">Domaine</dt>
                    <dd class="mb-0">{% for domaine in this.formation.domaines %}
                            {{ domaine.libelle }}{% if not loop.last %}, {% endif %}
                        {% else %}
                            <span class="badge bg-danger">Non défini</span>
                        {% endfor %}</dd>
                </div>
                <div class="col-12 col-sm-6 col-lg-2">
                    <dt class="fw-medium text-muted mb-1">Type de diplôme</dt>
                    <dd class="mb-0">{{ formation.typeDiplome|typeDiplome }}</dd>
                </div>
                <div class="col-12 col-sm-6 col-lg-2">
                    <dt class="fw-medium text-muted mb-1">Composante</dt>
                    <dd class="mb-0">{{ formation.composantePorteuse != null ? formation.composantePorteuse.libelle : '<span class="badge bg-danger">Non définie</span>' }}</dd>
                </div>
                <div class="col-12 col-sm-6 col-lg-2">
                    <dt class="fw-medium text-muted mb-1">Mention</dt>
                    <dd class="mb-0">
                        {{ formation.display }}
                    </dd>
                </div>
                <div class="col-12 col-sm-6 col-lg-2">
                    <dt class="fw-medium text-muted mb-1">Responsable mention</dt>
                    <dd class="mb-0">
                        {{ formation.responsableMention != null ? formation.responsableMention.display : 'Non défini' }}
                    </dd>
                </div>
                <div class="col-12 col-sm-6 col-lg-2">
                    <dt class="fw-medium text-muted mb-1">Responsable parcours</dt>
                    <dd class="mb-0">
                        {{ parcours.respParcours != null ? parcours.respParcours.display : 'Non défini' }}
                        {% if parcours.coResponsable != null %}
                            <i class="fal fa-users" data-bs-toggle="tooltip" data-bs-placement="bottom"
                               title="Co-responsable : {{ parcours.coResponsable.display }}"></i>
                        {% endif %}
                    </dd>
                </div>
            </div>

            {# Compact Validation Timeline #}
            <div class="mt-3 pt-3 border-top">
                <h4 class="small fw-medium mb-2">Dates de validation</h4>
                <div class="row g-2">
                    {% for key, process in this.process %}
                        {% if process.isTimeline %}
                            <div class="col-12 col-sm-6 col-lg-3">
                                <div class="d-flex align-items-center gap-2 p-2 bg-white rounded border">
                                    {% if this.status(key) == 'completed' %}
                                        <i class="fas fa-check-circle text-success"></i>
                                    {% else %}
                                        <i class="fas fa-clock text-secondary"></i>
                                    {% endif %}
                                    <div class="flex-grow-1 text-truncate">
                                        <p class="small fw-medium mb-0 text-truncate">{{ (process.label~'.timeline')|trans({}, 'process') }}</p>
                                        <p class="small mb-0 {% if this.status(key) == 'completed' %}text-success{% else %}text-muted{% endif %}">
                                            {{ this.dateHistorique(key) }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>


        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
            {# Left: Title and Status #}
            <div class="d-flex align-items-center gap-1 flex-wrap">
                <div class="d-flex align-items-center gap-3">
                    {% if hasDemande == true %}
                        <div class="rounded-full flex items-center justify-center w-8 h-8 bg-green-200 bg-opacity-60 text-green-700 ring-1 ring-green-400 shadow-sm p-2"
                             data-controller="tooltip" data-tooltip-placement-value="bottom"
                             data-bs-original-title="Parcours en cours de modification."
                        >
                            <i class="fas fa-unlock small"></i>
                        </div>
                        <span class="text-green-600">Parcours en cours de modification.</span>
                    {% else %}
                        <div class="rounded-full flex items-center justify-center w-8 h-8 bg-amber-200 bg-opacity-60 text-amber-700 ring-1 ring-amber-400 shadow-sm p-2"
                             data-controller="tooltip" data-tooltip-placement-value="bottom"
                             data-bs-original-title="Parcours verrouillé."
                        >
                            <i class="fas fa-lock small"></i>
                        </div>
                        <span class="text-amber-600">Parcours verrouillé.</span>
                    {% endif %}
                </div>
            </div>

            <div class="d-flex align-items-center gap-1 flex-wrap">
                <div class="mt-3 d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
                    <div class="d-flex align-items-center gap-1 flex-wrap">
                        {% for key, step in processSteps %}
                            {% if validationSteps[key] is defined and validationSteps[key].status == 'completed' %}
                                {% set class = 'success' %}
                            {% elseif validationSteps[key] is defined and validationSteps[key].status == 'active' %}
                                {% set class = 'info' %}
                            {% elseif validationSteps[key] is defined and validationSteps[key].status == 'reserved' %}
                                {% set class = 'warning' %}
                            {% elseif validationSteps[key] is defined and validationSteps[key].status == 'refused' %}
                                {% set class = 'danger' %}
                            {% else %}
                                {% set class = 'muted' %}
                            {% endif %}
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle d-flex align-items-center justify-content-center
                                bg-{{ class }}-subtle text-{{ class }} bubble-process"
                                     data-controller="tooltip" data-tooltip-placement-value="bottom"
                                     aria-label="{{ (prefix~'.'~step.label~'.btn-'~class)|trans({}, 'process') }}"
                                     data-bs-original-title="{{ (prefix~'.'~step.label~'.btn-'~class)|trans({}, 'process') }}"
                                >
                                    <i class="fas {{ step.icon }} small"></i>
                                </div>
                                {% if not loop.last %}
                                    <div class="bg-{{ class }} bg-opacity-25"
                                         style="width: 16px; height: 2px; margin: 0 4px;">
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        {# Compact Process Timeline #}
        <div class="mt-3 mb-3 d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
            <div class="d-flex align-items-center gap-1 flex-wrap">

            </div>

            {# Quick Actions #}
            <div class="d-flex align-items-center gap-2">
                {# Validation Dropdown #}
                <button class="btn btn-sm btn-outline-secondary w-100">
                    <i class="fas fa-download"></i> Voir PV
                </button>

                <div class="dropdown">
                    <button class="btn btn-sm btn-success dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                    >
                        <i class="fas fa-check"></i> Gestion du DPE
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        {% for key, option in validationOptions %}
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2"
                                   data-action="click->modalturbo#open"
                                   data-turbo="true"
                                   href="{{ path('parcours_process_apply', {type: option.metadata.type, dpeParcours: dpeParcours.id, transition: key }) }}"
                                >
                                        <span class="rounded-circle d-flex align-items-center justify-content-center
                                           bg-{{ option.metadata.button_class }} text-white"
                                              style="width: 24px; height: 24px; font-size: 0.75rem;">
                                            <i class="fas {{ option.metadata.button_icon }}"></i>
                                        </span>
                                    <div>
                                        <div class="fw-medium">{{ ('workflow.'~key~'.menu.label')|trans({}, 'process') }}</div>
                                        <div class="small text-muted">{{ ('workflow.'~key~'.menu.description')|trans({}, 'process') }}</div>
                                    </div>
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <button class="btn btn-sm btn-outline-secondary"
                        data-toggle-group="accordion-1"
                        data-toggle="actions" data-target="#actions-panel">
                    <i class="fas fa-gear-complex"></i>
                    Actions complémentaires
                    <i class="fas fa-chevron-up data-toggle-icon"></i>
                </button>

                <button class="btn btn-sm btn-outline-info"
                        data-toggle-group="accordion-1"
                        data-toggle="actions" data-target="#exports-panel">
                    <i class="fas fa-download"></i>
                    Exports
                    <i class="fas fa-chevron-up data-toggle-icon"></i>
                </button>

                {% if is_granted('ROLE_ADMIN') %}
                    <button class="btn btn-sm btn-outline-secondary relative inline-flex items-center"
                            data-toggle-group="accordion-1"
                            data-toggle="actions"
                            data-target="#actions-panel-admin"
                    >
                        <i class="fas fa-wrench mr-2"></i>
                        Gestion SES
                        <i class="fas fa-chevron-up data-toggle-icon ml-2"></i>

                        {# Marqueur de notification #}
                        {% if parcours.commentaire != null %}
                            <span class="absolute -top-1 -right-1 flex h-3 w-3">
                        {#        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75"></span> #}
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-orange-500 border border-white"></span>
                            </span>
                        {% endif %}
                    </button>
                {% endif %}
            </div>
        </div>

        {# Expandable Actions Panel #}
        <div class="mt-3 mb-3 p-3 bg-light rounded border hidden"
             id="actions-panel"
        >
            <div class="row g-2">
                <div class="col-6 col-sm-4 col-lg-2">
                    <a class="btn btn-sm btn-primary w-100"
                       href="{{ path('app_parcours_bcc', {parcours:parcours.id}) }}">
                        <i class="fas fa-check"></i>
                        Contrôler les BCC
                    </a>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                    <a class="btn btn-sm btn-primary w-100"
                       href="{{ path('app_parcours_ec', {parcours:parcours.id}) }}">
                        <i class="fas fa-check"></i>
                        Contrôler la maquette
                    </a>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                    <button
                            {{ stimulus_controller('modal', {
                                size: 'lg',
                                modalTitle: 'verifier.la.saisie.parcours.title'|trans({}, 'process'),
                                modalUrl: path('app_parcours_state', {parcours:parcours.id}) }) }}
                            data-action="click->modal#openModal"
                            class="btn btn-sm btn-outline-success w-100"
                            data-size="lg"
                            data-bs-toggle="tooltip"
                            data-bs-placement="bottom"
                            title="{{ 'verifier.la.saisie.parcours.infobulle'|trans({}, 'process') }}"
                    >
                        <i class="fas fa-check"></i>
                        <span> Vérifier la saisie</span>
                    </button>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                    <a
                            href="{{ path('fiche_matiere_valide_parcours', {parcours: this.parcours.id}) }}"
                            class="btn btn-outline-success btn-sm w-100"
                            data-bs-toggle="tooltip"
                            data-bs-placement="bottom"
                            title="{{ 'verifier.fiches.ec.matieres.infobulle'|trans({}, 'process') }}"
                    >
                        <i class="fas fa-check"></i>
                        <span> Valider les fiches EC/matières</span>
                    </a>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                    <button class="btn btn-sm btn-outline-primary w-100" type="button"
                            {{ stimulus_controller('modal', {
                                size: 'large',
                                modalTitle: 'historique.de.validation.parcours.title'|trans({}, 'process'),
                                right: true,
                                modalUrl: path('app_historique_parcours', {parcours:this.parcours.id}) }) }}
                            data-action="click->modal#openModal"
                            data-size="lg"
                            data-bs-toggle="tooltip"
                            data-bs-placement="bottom"
                            title="{{ 'historique.de.validation.parcours.infobulle'|trans({}, 'process') }}"
                    >
                        <i class="fal fa-timeline"></i> Historique
                    </button>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                    {% if is_granted('ROLE_ADMIN')
                        and hasLastVersion is defined
                        and hasLastVersion == true %}
                        <a class="btn btn-sm btn-outline-warning d-block"
                           data-bs-toggle="collapse" data-bs-target="#diffGlobalParcours"
                        >
                            <i class="fa-light fa-not-equal"></i>
                            Comparer les descriptifs
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {# fin Expandable Actions Panel #}

        {# Expandable Exports Panel #}
        <div class="mt-3 mb-3 p-3 bg-light rounded border hidden"
             id="exports-panel"
        >
            <div class="row g-2">
                <div class="col-6 col-sm-4 col-lg-2">
                    <a class="btn btn-sm btn-primary w-100"
                       href="{{ path('app_parcours_export', {parcours:parcours.id}) }}"
                       data-bs-toggle="tooltip"
                       data-bs-placement="bottom"
                       title="Télécharger en PDF"
                    >
                        <i class="{{ iconDownload }}"></i> Fiche descriptive (PDF)
                    </a>
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-6 col-sm-4 col-lg-2">
                    MCCC
                </div>
                {% if hasLastVersion is defined and hasLastVersion == true %}
                    <div class="col-6 col-sm-4 col-lg-2">
                        <a class="btn btn-outline-primary btn-sm w-100"
                           href="{{ path('app_parcours_mccc_export_versionning', {parcours:parcours.id, _format:'xlsx'}) }}">
                            Export MCCC Version (xlsx)
                        </a>
                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">
                        <a class="btn btn-outline-primarybtn-sm  w-100"
                           href="{{ path('app_parcours_mccc_export_cfvu_valid', {parcours:parcours.id, format:'complet'}) }}">
                            Version complète (pdf)
                        </a>
                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">
                        <a class="btn btn-outline-primary btn-sm w-100"
                           href="{{ path('app_parcours_mccc_export_cfvu_valid', {parcours:parcours.id, format:'simplifie'}) }}">
                            Version simplifiée (pdf)
                        </a>
                    </div>
                {% else %}
                    <div class="col-6 col-sm-4 col-lg-2">
                        <a class="btn btn-outline-primary btn-sm w-100"
                           href="{{ path('app_parcours_mccc_export', {parcours:parcours.id, _format:'xlsx'}) }}">
                            Version complète (xlsx)
                        </a>
                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">
                        <a class="btn btn-outline-primary btn-sm w-100"
                           href="{{ path('app_parcours_mccc_export_light', {parcours:parcours.id, _format:'xlsx'}) }}">Version
                            simplifiée (xlsx)</a>
                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">
                        <a class="btn btn-outline-primary btn-sm w-100"
                           href="{{ path('app_parcours_mccc_export_cfvu_valid', {parcours:parcours.id, format:'complet'}) }}">
                            Version complète (pdf)
                        </a>
                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">
                        <a class="btn btn-outline-primary btn-sm w-100"
                           href="{{ path('app_parcours_mccc_export_cfvu_valid', {parcours:parcours.id, format:'simplifie'}) }}">Version
                            simplifiée (pdf)</a>
                    </div>
                {% endif %}
            </div>
            <div class="row g-2 mt-2">
                <div class="col-6 col-sm-4 col-lg-2">
                    BCC
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                    <a class="btn btn-sm btn-outline-warning w-100"
                       href="{{ path('app_parcours_bcc', {parcours:parcours.id}) }}">
                        Voir en ligne
                    </a>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                    <a class="btn btn-sm btn-outline-warning w-100"
                       href="{{ path('app_competence_export_bcc', {parcours:parcours.id}) }}">
                        Export des BCC (pdf)
                    </a>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                    <a class="btn btn-sm btn-outline-warning w-100"
                       href="{{ path('app_competence_export_croise', {parcours:parcours.id}) }}">
                        Croisé BCC/EC, semestre (pdf)
                    </a>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                    <a class="btn btn-sm btn-outline-warning w-100"
                       href="{{ path('app_competence_export_croise_global', {parcours:parcours.id}) }}">
                        Croisé BCC/EC, global (xslx)
                    </a>
                </div>
            </div>
        </div>
        {# fin Expandable Exports Panel #}

        {% if is_granted('ROLE_ADMIN') %}
            <div class="mt-3 mb-3 p-3 bg-light rounded border hidden"
                 id="actions-panel-admin"
            >
                <div class="row g-2">
                    <div class="col-6 col-sm-4 col-lg-2">
                        <a class="btn btn-sm btn-outline-secondary w-100"
                           data-action="click->modalturbo#open"
                           data-turbo="true"
                           href="{{ path('parcours_ses_changer_etat', { dpeParcours: dpeParcours.id }) }}"

                        >
                            <i class="fas fa-wrench"></i> Changer état DPE
                        </a>
                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">
                        <a class="btn btn-sm btn-outline-secondary w-100"
                           data-action="click->modalturbo#open"
                           data-turbo="true"
                           href="{{ path('parcours_ses_changer_ouverture', { dpeParcours: dpeParcours.id }) }}"
                        >
                            <i class="fas fa-door-open"></i> Modifier ouverture
                        </a>
                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">
                        <a class="btn btn-sm btn-outline-secondary w-100 relative inline-flex items-center justify-center"
                           data-action="click->modalturbo#open"
                           data-turbo="true"
                           href="{{ path('parcours_ses_commentaires', { dpeParcours: dpeParcours.id }) }}"
                        >
                            <i class="fas fa-comments mr-2"></i> Commentaires

                            {# Le marqueur (Badge) #}
                            {% if parcours.commentaire != null %}
                                <span class="absolute -top-1 -right-1 flex h-3 w-3">
                        {#        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span> #}
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500 border border-white"></span>
                                </span>
                            {% endif %}
                        </a>

                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">
                        <button class="btn btn-sm btn-outline-secondary w-100">
                            <i class="fas fa-print"></i> Mettre à jours PDF
                        </button>
                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">
                        <button class="btn btn-sm btn-outline-secondary w-100">
                            <i class="fas fa-cog"></i> Gérer codification
                        </button>
                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">

                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>


