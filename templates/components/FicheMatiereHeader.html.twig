{# templates/components/CourseHeader.html.twig #}
<div {{ attributes }} class="card card-body mb-3">
    {% set prefix = 'fiche_matiere' %}
    {% set formation = ficheMatiere.parcours?.formation %}
    <div class="container-fluid px-lg-4 pt-3">
        <div class="mb-3 p-3 bg-light rounded border">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
                <div class="flex flex-col">
                    <dt class="fw-medium text-muted mb-1">Type de fiche matière</dt>
                    <dd class="mb-0">
                        {% if ficheMatiere.horsDiplome == true %}
                            <span class="badge bg-warning">Hors Diplome</span>
                        {% else %}
                            <span class="badge bg-info">Classique</span>
                        {% endif %}
                    </dd>
                </div>
                <div class="flex flex-col">
                    <dt class="fw-medium text-muted mb-1">Mention porteuse</dt>
                    <dd class="mb-0">
                        {{ formation != null ? formation.display : '' }}
                    </dd>
                </div>
                <div class="flex flex-col">
                    <dt class="fw-medium text-muted mb-1">Parcours porteur</dt>
                    <dd class="mb-0">
                        {% if ficheMatiere.horsDiplome == false %}
                            {% if ficheMatiere.parcours != null %}
                                {% if ficheMatiere.parcours.parcoursDefaut == false %}
                                    {{ ficheMatiere.parcours.libelle }}
                                {% else %}
                                    Mention sans parcours
                                {% endif %}
                            {% else %}
                                Pas de parcours précisé
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </dd>
                </div>
                <div class="flex flex-col">
                    <dt class="fw-medium text-muted mb-1">Composante porteuse</dt>
                    <dd class="mb-0">
                        {% if ficheMatiere.horsDiplome == false %}
                            {{ (formation != null and formation.composantePorteuse != null) ? formation.composantePorteuse.libelle : 'erreur' }}
                        {% else %}
                            -
                        {% endif %}
                    </dd>
                </div>
                <div class="flex flex-col">
                    <dt class="fw-medium text-muted mb-1">Responsable Fiche</dt>
                    <dd class="mb-0">
                        {{ ficheMatiere.responsableFicheMatiere.display }}
                    </dd>
                </div>
            </div>
        </div>


        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
            {# Left: Title and Status #}
            <div class="d-flex align-items-center gap-1 flex-wrap">
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex align-items-center gap-1 flex-wrap">
                        <div class="rounded-circle d-flex align-items-center justify-content-center
                                bg-warning-subtle text-warning bubble-process"
                             data-controller="tooltip" data-tooltip-placement-value="bottom"
                             aria-label="..."
                             data-bs-original-title="..."
                        >
                            <i class="fas fa-lock small"></i>
                        </div>
                        Fiche matière verrouillée. {# todo: a gérer avec ouverture/réouverture en modif #}
                    </div>
                </div>
            </div>

            <div class="d-flex align-items-center gap-1 flex-wrap">
                <div class="mt-3 d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
                    <div class="d-flex align-items-center gap-1 flex-wrap">
                        {% for key, step in processSteps %}
                            {% if validationSteps[key] is defined and validationSteps[key].status == 'completed' %}
                                {% set class = 'success' %}
                            {% elseif validationSteps[key] is defined and validationSteps[key].status == 'active' %}
                                {% set class = 'info' %}
                            {% elseif validationSteps[key] is defined and validationSteps[key].status == 'reserved' %}
                                {% set class = 'warning' %}
                            {% elseif validationSteps[key] is defined and validationSteps[key].status == 'refused' %}
                                {% set class = 'danger' %}
                            {% else %}
                                {% set class = 'muted' %}
                            {% endif %}
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle d-flex align-items-center justify-content-center
                                bg-{{ class }}-subtle text-{{ class }} bubble-process"
                                     data-controller="tooltip" data-tooltip-placement-value="bottom"
                                     aria-label="{{ (prefix~'.'~step.label~'.btn-'~class)|trans({}, 'process') }}"
                                     data-bs-original-title="{{ (prefix~'.'~step.label~'.btn-'~class)|trans({}, 'process') }}"
                                >
                                    <i class="fas {{ step.icon }} small"></i>
                                </div>
                                {% if not loop.last %}
                                    <div class="bg-{{ class }} bg-opacity-25"
                                         style="width: 16px; height: 2px; margin: 0 4px;">
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        {# Compact Process Timeline #}
        <div class="mt-3 mb-3 d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
            <div class="d-flex align-items-center gap-1 flex-wrap">
                {# place libre à gauche #}
            </div>

            {# Quick Actions #}
            <div class="d-flex align-items-center gap-2">
                {# Validation Dropdown #}

                {% if is_granted('MANAGE', {route: 'app_fiche_matiere', subject: ficheMatiere}) or is_granted('ROLE_ADMIN') %}
                    réouverture
                    {#                    <button #}
                    {#                            href="#" #}
                    {#                            {{ stimulus_controller('modal', { #}
                    {#                                size: 'lg', #}
                    {#                                modalTitle: 'fiche_matiere.change_rf.title'|trans({}, 'form'), #}
                    {#                                nomEvenement: 'refreshPage', #}
                    {#                                modalUrl: path('app_fiche_matiere_change_rf', {fiche_matiere: fiche_matiere.id}) }) }} #}
                    {#                            data-action="click->modal#openModal" #}
                    {#                            data-size="lg" #}
                    {#                            class="btn btn-sm btn-outline-warning w-100" #}
                    {#                            data-bs-toggle="tooltip" #}
                    {#                            data-bs-placement="bottom" #}
                    {#                            title="{{ 'fiche_matiere.change_rf.title'|trans({}, 'form') }}" #}
                    {#                    > #}
                    {#                        <i class="fal fa-repeat"></i> #}
                    {#                        <span> {{ 'fiche_matiere.change_rf.label'|trans({}, 'form') }}</span> #}
                    {#                    </button> #}
                {% endif %}

                <button class="btn btn-sm btn-outline-secondary w-100">
                    <i class="fas fa-download"></i> Voir PV
                </button>

                <div class="dropdown">
                    <button class="btn btn-sm btn-success dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                    >
                        <i class="fas fa-check"></i> Gestion du DPE
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        {% for key, option in validationOptions %}
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2"
                                   data-action="click->modalturbo#open"
                                   data-turbo="true"
                                   href="{{ path('fiche_matiere_process_apply', {type: option.metadata.type, ficheMatiere: ficheMatiere.id, transition: key }) }}"
                                >
                                        <span class="rounded-circle d-flex align-items-center justify-content-center
                                           bg-{{ option.metadata.button_class }} text-white"
                                              style="width: 24px; height: 24px; font-size: 0.75rem;">
                                            <i class="fas {{ option.metadata.button_icon }}"></i>
                                        </span>
                                    <div>
                                        <div class="fw-medium">{{ ('workflow.'~key~'.menu.label')|trans({}, 'process') }}</div>
                                        <div class="small text-muted">{{ ('workflow.'~key~'.menu.description')|trans({}, 'process') }}</div>
                                    </div>
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <button class="btn btn-sm btn-outline-secondary"
                        data-toggle-group="accordion-1"
                        data-toggle="actions" data-target="#actions-panel">
                    <i class="fas fa-gear-complex"></i>
                    Actions complémentaires
                    <i class="fas fa-chevron-up data-toggle-icon"></i>
                </button>

                <button class="btn btn-sm btn-outline-info"
                        data-toggle-group="accordion-1"
                        data-toggle="actions" data-target="#exports-panel">
                    <i class="fas fa-download"></i>
                    Exports
                    <i class="fas fa-chevron-up data-toggle-icon"></i>
                </button>

                {% if is_granted('ROLE_ADMIN') %}
                    <button class="btn btn-sm btn-outline-secondary"
                            data-toggle-group="accordion-1"
                            data-toggle="actions" data-target="#actions-panel-admin"
                    >
                        <i class="fas fa-wrench"></i>
                        Gestion SES
                        <i class="fas fa-chevron-up data-toggle-icon"></i>
                    </button>
                {% endif %}
            </div>
        </div>

        {# Expandable Actions Panel #}
        <div class="mt-3 mb-3 p-3 bg-light rounded border hidden"
             id="actions-panel"
        >
            <div class="row g-2">
                <div class="col-6 col-sm-4 col-lg-2">
                    <button
                            {#                            {{ stimulus_controller('modal', { #}
                            {#                                size: 'lg', #}
                            {#                                modalTitle: 'verifier.la.saisie.fiche_matiere.title'|trans({}, 'process'), #}
                            {#                                modalUrl: path('app_fiche_matiere_state', {fiche_matiere:ficheMatiere.id}) }) }} #}
                            data-action="click->modal#openModal"
                            class="btn btn-sm btn-outline-success w-100"
                            data-size="lg"
                            data-bs-toggle="tooltip"
                            data-bs-placement="bottom"
                            title="{{ 'verifier.la.saisie.fiche_matiere.infobulle'|trans({}, 'process') }}"
                    >
                        <i class="fas fa-check"></i>
                        <span> Vérifier la saisie</span>
                    </button>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                    <button class="btn btn-sm btn-outline-primary w-100" type="button"
                            {{ stimulus_controller('modal', {
                                size: 'large',
                                modalTitle: 'historique.de.validation.fiche_matiere.title'|trans({}, 'process'),
                                right: true,
                                modalUrl: path('app_historique_fiche_matiere', {ficheMatiere:ficheMatiere.id}) }) }}
                            data-action="click->modal#openModal"
                            data-size="lg"
                            data-bs-toggle="tooltip"
                            data-bs-placement="bottom"
                            title="{{ 'historique.de.validation.fiche_matiere.infobulle'|trans({}, 'process') }}"
                    >
                        <i class="fal fa-timeline"></i> Historique
                    </button>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                    {% if is_granted('ROLE_ADMIN')
                        and hasLastVersion is defined
                        and hasLastVersion == true %}
                        <a class="btn btn-sm btn-outline-warning d-block"
                           data-bs-toggle="collapse" data-bs-target="#diffGlobalParcours"
                        >
                            <i class="fa-light fa-not-equal"></i>
                            Comparer les descriptifs
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {# fin Expandable Actions Panel #}

        {# Expandable Exports Panel #}
        <div class="mt-3 mb-3 p-3 bg-light rounded border hidden"
             id="exports-panel"
        >
            <div class="row g-2 mt-2">
                <div class="col-6 col-sm-4 col-lg-2">
                    <a href="{{ path('app_fiche_matiere_export', {id:ficheMatiere.id}) }}"
                       class="btn btn-primary btn-sm w-100"
                       data-bs-toggle="tooltip"
                       data-bs-placement="bottom"
                       title="Télécharger en PDF"
                    >
                        <i class="{{ iconDownload }}"></i>
                        <span> Fiche descriptive (PDF)</span>
                    </a>
                </div>
            </div>
        </div>
        {# fin Expandable Exports Panel #}

        {% if is_granted('ROLE_ADMIN') %}
            <div class="mt-3 mb-3 p-3 bg-light rounded border hidden"
                 id="actions-panel-admin"
            >
                <div class="row g-2">
                    <div class="col-6 col-sm-4 col-lg-2">
                        <button class="btn btn-sm btn-outline-secondary w-100">
                            <i class="fas fa-cog"></i> Gérer codification
                        </button>
                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">
                        <button class="btn btn-sm btn-outline-secondary w-100">
                            <i class="fas fa-cog"></i> Gérer la version
                        </button>
                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">

                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">

                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">

                    </div>
                    <div class="col-6 col-sm-4 col-lg-2">

                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>
